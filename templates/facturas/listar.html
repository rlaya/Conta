
<!-- templates/facturas/listar.html -->

{% extends "base.html" %}

{% block content %}

<div class="container mt-4 mb-5">
    <h2 class="mb-4 text-primary fw-bold">üßæ Gesti√≥n de Facturas</h2>

    <!-- Zona de Creaci√≥n y Exportaci√≥n -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        
        <div>
            <a href="{{ url_for('menu') }}" class="btn btn-secondary me-2">Men√∫ Principal</a>
            <a href="{{ url_for('crear_factura') }}" class="btn btn-success shadow-sm">‚ûï Crear Nueva Factura</a>
        </div>    

        <div class="btn-group">
            <a href="{{ url_for('exportar_facturas') }}" class="btn btn-outline-primary shadow-sm" title="Exportar todas las facturas a Excel">
                üì• Exportar a Excel
            </a>
            <a href="{{ url_for('exportar_facturas_pdf') }}" class="btn btn-outline-danger shadow-sm" title="Generar reporte PDF de todas las facturas">
                üìÑ Exportar a PDF
            </a>
        </div>
    </div>
    
    <!-- 1. FILTROS Y B√öSQUEDA (Colapsable para mejor Responsividad) -->
    <div class="accordion mb-4" id="accordionFiltros">
        <div class="accordion-item shadow-sm border-primary border-2 rounded">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button bg-primary text-white collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltros" aria-expanded="false" aria-controls="collapseFiltros">
                    üîç Opciones de B√∫squeda y Filtro
                </button>
            </h2>
            <div id="collapseFiltros" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionFiltros">
                <div class="accordion-body bg-light">
                    <form method="GET" action="{{ url_for('facturas_view') }}">
                        <div class="row g-3">
                            
                            <!-- B√∫squeda por Folio/Tercero -->
                            <div class="col-md-6 col-lg-3">
                                <label for="search_query" class="form-label">Folio o Tercero</label>
                                <input type="text" class="form-control" id="search_query" name="search_query" placeholder="Buscar por Folio o Nombre..." value="{{ filtros.search_query or '' }}">
                            </div>

                            <!-- Filtro por Tipo -->
                            <div class="col-md-6 col-lg-2">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo">
                                    <option value="">Todos</option>
                                    <option value="venta" {% if filtros.tipo == 'venta' %}selected{% endif %}>Venta</option>
                                    <option value="compra" {% if filtros.tipo == 'compra' %}selected{% endif %}>Compra</option>
                                </select>
                            </div>

                            <!-- Filtro por Estatus -->
                            <div class="col-md-6 col-lg-2">
                                <label for="estatus" class="form-label">Estatus</label>
                                <select class="form-select" id="estatus" name="estatus">
                                    <option value="">Todos</option>
                                    <option value="activa" {% if filtros.estatus == 'activa' %}selected{% endif %}>Activa</option>
                                    <option value="pagada" {% if filtros.estatus == 'pagada' %}selected{% endif %}>Pagada</option>
                                    <option value="cancelada" {% if filtros.estatus == 'cancelada' %}selected{% endif %}>Cancelada</option>
                                </select>
                            </div>
                            
                            <!-- L√≠neas por P√°gina (Paginaci√≥n) -->
                            <div class="col-md-6 col-lg-2">
                                <label for="per_page" class="form-label">L√≠neas por p√°g.</label>
                                <select class="form-select" id="per_page" name="per_page">
                                    {% for size in [5, 10, 20, 50] %}
                                    <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Bot√≥n de Aplicar Filtros -->
                            <div class="col-12 col-lg-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100 me-2">Aplicar Filtros</button>
                                <a href="{{ url_for('facturas_view', per_page=per_page) }}" class="btn btn-outline-secondary">Limpiar</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN FILTROS -->

    <!-- Tabla de Facturas -->
    <div class="table-responsive shadow-lg rounded">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th scope="col" class="d-none d-sm-table-cell">ID</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Folio</th>
                    <th scope="col" class="d-none d-md-table-cell">Fecha</th>
                    <th scope="col" class="d-none d-lg-table-cell">Vencimiento</th>
                    <th scope="col" class="text-end">Total</th>
                    <th scope="col">Tercero</th>
                    <th scope="col">Estatus</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for f in facturas %}
                <tr class="{% if f[7] == 'cancelada' %}table-danger{% endif %}">
                    <td class="d-none d-sm-table-cell"><span class="badge bg-secondary">{{ f[0] }}</span></td>
                    <td><span class="badge {% if f[1] == 'venta' %}bg-success{% else %}bg-danger{% endif %}">{{ f[1].capitalize() }}</span></td>
                    <td class="fw-bold">{{ f[2] }}</td>
                    <td class="d-none d-md-table-cell">{{ f[3] }}</td>
                    <td class="d-none d-lg-table-cell">{{ f[4] or '‚Äî' }}</td>
                    <td class="text-end fw-bold text-nowrap">{{ "%.2f"|format(f[5]) }}</td>
                    <td>{{ f[6] or '‚Äî' }}</td>
                    <td>
                        {% if f[7] == 'activa' %}
                            <span class="badge bg-success">Activa</span>
                        {% elif f[7] == 'cancelada' %}
                            <span class="badge bg-danger">Cancelada</span>
                        {% elif f[7] == 'pagada' %}
                            <span class="badge bg-primary">Pagada</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">{{ f[7] }}</span>
                        {% endif %}
                    </td>
                    <td class="text-nowrap">
                        <div class="btn-group" role="group" aria-label="Acciones Factura">
                            <a href="{{ url_for('ver_factura', id_factura=f[0]) }}" class="btn btn-sm btn-info" title="Ver Detalle">üëÅÔ∏è</a>
                            <a href="{{ url_for('editar_factura', id_factura=f[0]) }}" class="btn btn-sm btn-warning" title="Editar Factura">‚úèÔ∏è</a>
                            <!-- Bot√≥n de cancelar/eliminar si fuera necesario -->
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9">
                        <div class="alert alert-info text-center mt-3" role="alert">
                            No se encontraron facturas con los filtros aplicados.
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 2. NAVEGACI√ìN DE PAGINACI√ìN -->
    {% if pagination and pagination.pages > 1 %}
    <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <small class="text-muted">
            Mostrando p√°gina {{ pagination.page }} de {{ pagination.pages }} (Total: {{ pagination.total }} facturas).
        </small>
        
        <nav aria-label="Navegaci√≥n de P√°ginas">
            <ul class="pagination pagination-sm mb-0 shadow-sm">
                
                <!-- Bot√≥n Anterior -->
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('facturas_view', page=pagination.prev_num, per_page=per_page, **filtros) }}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                
                <!-- N√∫meros de P√°gina (ejemplo de rango simple) -->
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
                    {% if p %}
                        {% if p == pagination.page %}
                        <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ p }}</a></li>
                        {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('facturas_view', page=p, per_page=per_page, **filtros) }}">{{ p }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                    {% endif %}
                {% endfor %}
                
                <!-- Bot√≥n Siguiente -->
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('facturas_view', page=pagination.next_num, per_page=per_page, **filtros) }}" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </div>
    {% endif %}

</div>

{% endblock %} 